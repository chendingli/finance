<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>后台管理系统</title>
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,user-scalable=yes, minimum-scale=0.4, initial-scale=0.8" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <meta http-equiv=“X-UA-Compatible” content=“chrome=1″ />
    <link rel="shortcut icon" href="./images/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="./css/font.css">
    <link rel="stylesheet" href="./css/xadmin.css">
    <link rel="stylesheet" href="./fonts/my-iconfont/iconfont.css">
    <script type="text/javascript" src="./js/jquery.min.js"></script>
    <script type="text/javascript" src="./lib/layui/layui.js" charset="utf-8"></script>
    <script type="text/javascript" src="./js/xadmin.js"></script>
    <script type="text/javascript" src="./js/common.js"></script>
    <link rel="stylesheet" href="./lib/zTree_v3/css/zTreeStyle/zTreeStyle.css" type="text/css">
    <script type="text/javascript" src="./lib/zTree_v3/js/jquery.ztree.core.js"></script>
    <script type="text/javascript" src="./lib/zTree_v3/js/jquery.ztree.excheck.js"></script>
    <!-- 让IE8/9支持媒体查询，从而兼容栅格 -->
    <!--[if lt IE 9]>
    <script type="text/javascript" src="./js/html5.min.js"></script>
    <script type="text/javascript" src="./js/respond.min.js"></script>
    <![endif]-->
</head>
<style>
    .add-sub:hover {
        cursor: pointer;
    }

</style>
<body>
    <div class="layui-container x-body">
        <div class="layui-row">
            <form class="layui-form" id="role-data" style="position: relative;left: 50%;margin-left: -250px">
                <div class="layui-form-item">
                    <label for="clientName" class="layui-form-label">
                        <span class="x-red">*</span>客户姓名
                    </label>
                    <div class="layui-input-inline">
                        <select name="clientName" id="clientName" class="clientName" lay-filter="clientName">
                            <option value="" selected>请选择</option>
                        </select>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label" style="width: 200px">
                        <span class="x-red" style="margin-left: 100px">
                        找不到？
                        </span>
                        <a href="javaScript:void(0)" id="add" style="color: #1E9FFF ">新增客户</a>
                    </label>

                </div>
                <div class="layui-form-item">
                    <label for="createName" class="layui-form-label">
                        <span class="x-red">*</span>创建人
                    </label>
                    <div class="layui-input-inline">
                        <input type="text" name="createName" id="createName" style="border: none" readonly autocomplete="off" class="layui-input" maxlength="20">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label for="type" class="layui-form-label">
                        <span class="x-red">*</span>支出类型
                    </label>
                    <div class="layui-input-inline">
                        <select name="type" id="type" class="type" lay-filter="type">
                            <option value="" selected>请选择</option>
                            <option value="0" >沟通</option>
                            <option value="1" >差旅</option>
                            <option value="2" >礼物</option>
                        </select>
                    </div>
                    <label for="expense" class="layui-form-label" style="margin-left: 25px">
                        <span class="x-red">*</span>支出总金额
                    </label>
                    <div class="layui-input-inline" >
                        <input type="text" name="expense" id="expense" placeholder="请填写" lay-verify="required|expense" autocomplete="off" class="layui-input" maxlength="20">
                    </div>
                </div>

                <div class="layui-form-item">

                </div>
                <div class="layui-form-item" id="f1" >
                    <label for="wayType" class="layui-form-label">
                        <span class="x-red">*</span>支出途径
                    </label>
                    <div class="layui-input-inline">
                        <div class="layui-input-inline">
                            <select name="wayType" id="wayType" class="wayType" lay-filter="wayType">
                                <option value="" selected>请选择</option>
                                <option value="0" >送礼</option>
                                <option value="1" >吃饭</option>
                                <option value="2" >打车</option>
                            </select>
                        </div>
                    </div>
                    <div class="layui-form-mid layui-word-aux">
                    <i class="iconfont add-sub" id="addWay">&#xe616;</i>
                    </div>
                    <label for="wayExpense" class="layui-form-label">
                        <span class="x-red">*</span>支出金额
                    </label>
                    <div class="layui-input-inline">
                        <input type="wayExpense" name="wayExpense" id="wayExpense" placeholder="请填写" lay-verify="required|expense2" autocomplete="off" class="layui-input" maxlength="20">
                    </div>

                </div>
                <div class="layui-form-item" id="f2">
                    <label for="time" class="layui-form-label">
                        <span class="x-red">*</span>时间
                    </label>
                    <div class="layui-input-inline">
                        <input type="text" name="time" placeholder="yyyy-MM-dd" id="time"  lay-verify="required|time" autocomplete="off" class="layui-input" maxlength="20">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label for="details" class="layui-form-label">
                        <span class="x-red">*</span>费用事由
                    </label>
                    <div class="layui-input-inline">
                        <textarea type="text" name="details" id="details" placeholder="请输入" lay-verify="required" autocomplete="off" class="layui-input" style="height: 120px;padding: 10px" maxlength="200"></textarea>
                    </div>
                </div>
                <div class="layui-col-md12" style="display: none;">
                    <div class="layui-form-item">
                        <label for="submit" class="layui-form-label">
                        </label>
                        <button class="layui-btn" id="submit" lay-filter="add" lay-submit>
                            提交
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <script>
        layui.use('laydate', function(){
            var laydate = layui.laydate;

            //执行一个laydate实例
            laydate.render({
                elem: '#time' //指定元素
            });
        });
    </script>
    <script>
        var flag = 0;

        $("#addWay").on('click',function () {
            $("#f2").before(
                '<div class="layui-form-item" id="f1'+flag+'" > ' +
                    '<label for="wayType'+flag+'" class="layui-form-label"> ' +
                        '<span class="x-red">'+"*"+'</span>'+"支出途径" +
                    '</label> ' +
                    '<div class="layui-input-inline">' +
                        '<div class="layui-input-inline"> ' +
                            '<select name="wayType" id="wayType'+flag+'" class="wayType'+flag+'" lay-filter="wayType'+flag+'" > ' +
                                '<option value="" selected>请选择</option> ' +
                                '<option value="0" >送礼</option>' +
                                '<option value="1" >吃饭</option>' +
                                '<option value="2" >打车</option>' +
                            '</select>'+
                        '</div> ' +
                    '</div> ' +
                    '<div class="layui-form-mid layui-word-aux"> ' +
                      '<i class="iconfont add-sub" name="deleteWay" id="f1'+flag+'"> &#xe74b;</i> ' +
                    '</div> ' +
                    '<label for="wayExpense" class="layui-form-label"> ' +
                        '<span class="x-red">*</span>'+"支出金额"+'' +
                    '</label>' +
                    '<div class="layui-input-inline"> ' +
                    '<input type="text" name="wayExpense" id="wayExpense'+flag+'" placeholder="请填写" lay-verify="expense2|required" autocomplete="off" class="layui-input" maxlength="20"> ' +
                    '</div> ' +
                '</div>'
            );flag = flag+1;
            layui.form.render();
            $(".iconfont").on('click',function () {
                if(this.getAttribute("name")=="deleteWay"){
                    var id = this.getAttribute("id");
                    $("#"+id).remove();
                }
            })
        })



    </script>

    <script>
        var index = parent.layer.getFrameIndex(window.name);
                $("#add").on('click', function () {
                    layeropen("添加客户", ['50%', '60%'], "client-add", "./client-add.html", ["确定", "取消"],
                        {
                            yes: function (index) {
                                // 确定按钮的回调
                                var iframe = window['layui-layer-iframe' + index];
                                iframe.app.submit(); // 触发提交
                            },
                            cancel: function (index) {
                                // 取消按钮的回调
                                layer.close(index);
                            },
                            success: function (layero, index) {
                                // 子窗口弹出前的回调
                                var iframe = window['layui-layer-iframe' + index];
                                iframe.app.init();
                            }
                        }
                    );
                })
    </script>
    <script>
        var app = {
            Commonmethod: Commonmethod(),
            baseurl: Commonmethod().baseUrl().baseurl,
            treeObj:null,
            init: function () {
                var _this = this;

                this.initForm();

                this.event();


            },



            initForm:function() {
                var _this = this;
                _this.Commonmethod.ajax(
                    _this.baseurl + '/api/oms/clientExpense/clientName',
                    null,
                    null,
                    function (res) {
                        layui.use('form', function () {
                            $.each(res.data, function (index, val) {
                                $("#clientName").append('<option value="' + val + '">' + val + '</option>');
                            });
                            $("#createName").val(JSON.parse(sessionStorage.getItem("user")).username);
                            layui.form.render()
                        })
                    }
                );
            },

            event:function(){
                var _this = this;

            },
            submit:function() {

                var _this = this;

                // 绑定表单提交
                layui.use('form', function () {
                    var form = layui.form;

                    form.verify({
                        expense:function (value,index) {
                            var divide = 0 ;
                            var reg = /^\d+(\.\d+)?$/;
                            if(!reg.exec(value)){
                                return '请输入数字';
                            }
                            $("input[name='wayExpense']").each(function (index) {
                                divide += $(this).val()*1;
                            })
                            if(divide*1!=value){
                                return '支出总金额应为支出途径金额之和';
                            }
                        }
                    });
                    form.on('submit(add)', function (data) {
                        console.log(data.field);
                        var d = "";
                        var m = "";
                        $("select[name='wayType']").each(function () {

                            var id = $(this).attr("id");
                            var value = $(this).val();
                                d = d+value+",";
                        })
                        $("input[name^='wayEx']").each(function () {
                            var name = $(this).attr("name");
                            var value = $(this).val();
                            m = m+value+",";
                        })
                        var clientName = $("#clientName").val();
                        var type = $("#type").val();
                        var expense = $("#expense").val();
                        var time = $("#time").val();
                        var details = $("#details").val();
                        var createName = $("#createName").val()
                        // 提交表单
                        _this.Commonmethod.ajax(
                                Commonmethod().baseUrl().baseurl + '/api/oms/clientExpense/add',
                            {
                                "clientName":clientName,
                                "type":type,
                                "expense":expense,
                                "time":time,
                                "details":details,
                                "way":d,
                                "wayExpense":m,
                                "createName":createName
                            },
                                null,
                                function (res) {
                                    var index = parent.layer.getFrameIndex(window.name);
                                    layer.close(index);
                                    parent.location.reload();
                                }
                        );
                        return false;

                    });
                });

                $('#submit').trigger('click');

            }
        };

        app.init();
    </script>
</body>

</html>